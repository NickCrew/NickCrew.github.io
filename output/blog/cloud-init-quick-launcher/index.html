<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html lang="en">
<!--<![endif]-->
	<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="author" content="Nick Ferguson">


        <title>piggah.xyz - <p>Cloud-init Quick Launcher</p></title>

            <link href="https://piggah.xyz/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="piggah.xyz Full Atom Feed" />
            <link href="https://piggah.xyz/blog/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="piggah.xyz Full RSS Feed" />

        <!-- CSS -->
        <link rel="stylesheet" href="../../theme/css/style.css">

        <!-- Custom CSS -->
        	<link rel="stylesheet" href="../../theme/css/colors/blue.css" id="colors">

        <!-- Code highlight color scheme -->
            <link href="../../theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




        <meta name="tags" contents="virtualization" />
        <meta name="tags" contents="python" />
        <meta name="tags" contents="libvirt" />
        <meta name="tags" contents="kvm" />
        <meta name="tags" contents="snippets" />

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="piggah.xyz">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="../../blog/cloud-init-quick-launcher/">
	<meta property="og:title" content="<p>Cloud-init Quick Launcher</p>">
	<meta property="og:description" content="">
	   <meta property="og:image" content="../../images/guilherme-toti.jpg">
	<meta property="article:published_time" content="2018-08-24 00:00:00-04:00">
	</head>
	<body>
		<header id="header">
			<!-- Container -->
			<div class="container">
				<!-- Logo / Mobile Menu -->
				<div class="five columns">
					<div id="textlogo">
						<h1><a href="../../">piggah.xyz</a></h1>
					</div>
				</div>
						<!-- Navigation
				================================================== -->
				<div class="eleven columns">

					<nav id="navigation" class="menu">
						<ul id="responsive">

							<li><a href="../../">Home</a></li>

							    <li><a href="blog">Archives</a></li>

						</ul>
					</nav>
				</div>
			</div>
			<!-- Container / End -->
		</header>
		<!-- Header / End -->

		<!-- Breadcrumbs Container-->
		<div id="content-wrapper">
			<section id="titlebar">
				<!-- Container -->
				<div class="container">
				<div class="thirteen columns">
					<nav id="breadcrumbs">
						<ul>
							<li>You are here:</li>
							<li><a href="../../">Home</a></li>
<li><a href="../../category/tutorials.html">Tutorials</a></li>
<li><p>Cloud-init Quick Launcher</p></li>
						</ul>
					</nav>
				</div>
				</div>
				<!-- Container / End -->
			</section>

			<div class="container">
	<div class="twelve alt columns">
<article class="post" style="margin: 0; border: 0;">

	<div class="post-format">
		<div class="circle"><i class="icon-pencil"></i><span></span></div>
	</div>

	<section class="post-content">

		<header class="meta">
			<h2><a href="../../blog/cloud-init-quick-launcher/"><p>Cloud-init Quick Launcher</p></a></h2>
			<ul>
				<li>By <a href="../../author/nick-ferguson.html">Nick Ferguson</a></li>
				<li>Fri 24 August 2018</li>
			</ul>
		</header>

		<hr>
<h1>Synopsis</h1>
<p><strong>Quickly launch and provision VMs from cloud-init images uses a simple Python script</strong> </p>
<hr>
<p>Cloud images are pre-built VMs, essentially, configurable by a <strong>user-data</strong> script. They  rely on the cloud-init package, which is already installed on the image at the time you boot it. Cloud images are typically 200-300mb and can come in a variety of formats,common ones being .qcow2 and .raw. They start very quickly since you are skipping the installation and going straight to the provisioning. You can supply a huge number of provisioning options in the user-data file. They are primarily used by public cloud  platforms, OpenStack deployments, etc.  </p>
<hr>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Launch a VM with cloud-init. Ubuntu Bionic or Fedora 28.&#39;</span>
    <span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hostname&#39;</span><span class="p">,</span> 
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Hostname for your new VM.&#39;</span>
    <span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--memory&#39;</span><span class="p">,</span> 
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;1024&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Specify memory in MBs. Default is 1024.&#39;</span>
    <span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--distro&#39;</span><span class="p">,</span> 
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> 
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;ubuntu&#39;</span><span class="p">,</span>
    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ubuntu&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;fedora&#39;</span><span class="p">],</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Choose Ubuntu or Fedora. Default is ubuntu.&#39;</span>
    <span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(messages)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">distro</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">distro</span><span class="p">)</span>
<span class="n">src_img</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">distro</span> <span class="o">+</span> <span class="s1">&#39;.img&#39;</span>

<span class="k">if</span> <span class="n">distro</span> <span class="o">==</span> <span class="s1">&#39;ubuntu&#39;</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.img&#39;</span>
    <span class="n">vm_vari</span> <span class="o">=</span> <span class="s2">&quot;ubuntu16.04&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://download.fedoraproject.org/pub/fedora/linux/releases/28/Cloud/x86_64/images/&#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Fedora-Cloud-Base-28-1.1.x86_64.qcow2&#39;</span>
    <span class="n">vm_vari</span> <span class="o">=</span> <span class="s2">&quot;fedora27&quot;</span>


<span class="c1"># Make sure we have an Ubuntu cloud image, download latest if not</span>
<span class="n">fcheck</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src_img</span><span class="p">)</span>
<span class="k">if</span> <span class="n">fcheck</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We need to download the cloud image. One moment please.&#39;</span><span class="p">)</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="n">src_img</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cloud image obtained.&#39;</span><span class="p">)</span>

<span class="n">vm_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
<span class="n">vm_ram</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>

<span class="c1"># new vm will go in the os/ directory</span>
<span class="n">vm_path</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">+</span> <span class="s1">&#39;/os/&#39;</span> <span class="o">+</span> <span class="n">vm_name</span> <span class="o">+</span> <span class="s1">&#39;.img&#39;</span>

<span class="c1"># copy the new virtual disk we will install to</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_img</span><span class="p">,</span> <span class="n">vm_path</span><span class="p">)</span>

<span class="c1"># create the temp working dir. assuming the repo was cloned you have a</span>
<span class="c1"># templates/ folder with user-data and meta-data files</span>
<span class="n">tmp_drive</span> <span class="o">=</span> <span class="s1">&#39;/tmp/drives/latest&#39;</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp_drive</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_drive</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_drive</span><span class="p">)</span>
<span class="n">templates_dir</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">+</span> <span class="s1">&#39;/templates&#39;</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">templates_dir</span> <span class="o">+</span> <span class="s1">&#39;/meta-data&#39;</span><span class="p">,</span> <span class="n">tmp_drive</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">templates_dir</span> <span class="o">+</span> <span class="s1">&#39;/user-data&#39;</span><span class="p">,</span> <span class="n">tmp_drive</span><span class="p">)</span>

<span class="c1"># Create a meta-data file with the desired hostname</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_drive</span> <span class="o">+</span> <span class="s1">&#39;/meta-data&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">filedata</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">filedata</span> <span class="o">=</span> <span class="n">filedata</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@@HOSTNAME@@&#39;</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_drive</span> <span class="o">+</span> <span class="s1">&#39;/meta-data&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filedata</span><span class="p">)</span>

<span class="c1"># Generate the configuration iso</span>
<span class="n">iso_path</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">+</span> <span class="s1">&#39;/os/&#39;</span> <span class="o">+</span> <span class="n">vm_name</span> <span class="o">+</span> <span class="s1">&#39;-cidata.iso&#39;</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;genisoimage&#39;</span><span class="p">,</span> <span class="s1">&#39;-volid&#39;</span><span class="p">,</span> <span class="s1">&#39;cidata&#39;</span><span class="p">,</span> <span class="s1">&#39;-joliet&#39;</span><span class="p">,</span> <span class="s1">&#39;-rock&#39;</span><span class="p">,</span>
<span class="s1">&#39;-input-charset&#39;</span><span class="p">,</span> <span class="s1">&#39;iso8859-1&#39;</span><span class="p">,</span> <span class="s1">&#39;-output&#39;</span><span class="p">,</span> <span class="n">iso_path</span><span class="p">,</span> <span class="n">tmp_drive</span> <span class="o">+</span> <span class="s1">&#39;/user-data&#39;</span><span class="p">,</span> <span class="n">tmp_drive</span> <span class="o">+</span> <span class="s1">&#39;/meta-data&#39;</span><span class="p">])</span>


<span class="c1"># Install and launch the VM</span>
<span class="n">vinst_cmd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;virt-install&#39;</span><span class="p">,</span> <span class="s1">&#39;--import&#39;</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--name&#39;</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--vcpus&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;--memory&#39;</span><span class="p">,</span> <span class="n">vm_ram</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--os-type=linux&#39;</span><span class="p">,</span> <span class="s1">&#39;--os-variant=&#39;</span> <span class="o">+</span> <span class="n">vm_vari</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--network=default,model=virtio&#39;</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--vnc&#39;</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--noautoconsole&#39;</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--disk&#39;</span><span class="p">,</span> <span class="n">vm_path</span> <span class="o">+</span> <span class="s1">&#39;,format=qcow2,bus=virtio&#39;</span><span class="p">])</span>
<span class="n">vinst_cmd</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--disk&#39;</span><span class="p">,</span> <span class="s1">&#39;path=&#39;</span> <span class="o">+</span> <span class="n">dir_path</span> <span class="o">+</span> <span class="s1">&#39;/os/&#39;</span> <span class="o">+</span> <span class="n">vm_name</span> <span class="o">+</span> <span class="s1">&#39;-cidata.iso&#39;</span> <span class="o">+</span> <span class="s1">&#39;,device=cdrom&#39;</span><span class="p">])</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">vinst_cmd</span><span class="p">)</span>


<span class="c1"># Cleanup. Eject cdrom, delete tmp folders and iso</span>
<span class="c1">#subprocess.call([&#39;virsh change-media&#39;, vm_name + &#39; hda --eject&#39;])</span>
<span class="c1">#os.remove(iso_path)</span>
</pre></div>
</td></tr></table>
		    <div class="tags">
		        <p>tags: <a href="../../tag/virtualization.html">virtualization</a><a href="../../tag/python.html">python</a><a href="../../tag/libvirt.html">libvirt</a><a href="../../tag/kvm.html">kvm</a><a href="../../tag/snippets.html">snippets</a></p>
		    </div>

<div class="sharing">
</div>
<hr>

	</section>
	<div class="clearfix"></div>

</article>

	</div>

	<!-- Sidebar -->
	<div class="four columns">
		<!-- About  -->
		<div class="widget no-mg-top">
			<h3 class="headline">About</h3><span class="line"></span><div class="clearfix"></div>
			<p>Build and Release Platform Developer located in Clearwater, FL. Special focus on Linux & Containerized Apps, .NET Core, PowerShell, Build & Automation.</p>
		</div>

		<!-- Categories -->
		<div class="widget">
			<h3 class="headline">Categories</h3><span class="line"></span><div class="clearfix"></div>
			<nav class="categories">
				<ul>
					    <li><a href="../../category/articles.html">Articles</a></li>
					    <li class="active"><a href="../../category/tutorials.html">Tutorials</a></li>
				</ul>
			</nav>
		</div>
		
		<!-- Tags -->
		<div class="widget">
			<h3 class="headline">Tags</h3><span class="line"></span><div class="clearfix"></div>
			<nav class="tags">				    <a href="../../tag/applications.html">applications</a>
				    <a href="../../tag/dns.html">dns</a>
				    <a href="../../tag/freeipa.html">freeipa</a>
				    <a href="../../tag/identity.html">identity</a>
				    <a href="../../tag/kvm.html">kvm</a>
				    <a href="../../tag/lab.html">lab</a>
				    <a href="../../tag/libvirt.html">libvirt</a>
				    <a href="../../tag/networking.html">networking</a>
				    <a href="../../tag/openvswitch.html">OpenVSwitch</a>
				    <a href="../../tag/platforms.html">platforms</a>
				    <a href="../../tag/python.html">python</a>
				    <a href="../../tag/snippets.html">snippets</a>
				    <a href="../../tag/virtualization.html">virtualization</a>
			</nav>
		</div>
	</div>
			</div>
			<!-- Container / End -->
		</div>
		<!-- Content Wrapper / End -->

		<div id="footer-bottom">
			<!-- Container -->
			<div class="container">
				<div class="eight columns">&copy; Copyright 2020 Nick Ferguson || Blog powered by <a href="http://getpelican.com">Pelican</a></div>
					<div class="eight columns">
						<ul class="social-icons-footer">
								<li>
									<a href="https://github.com/NickCrew" class="tooltip top" title="Github">
										<i class="icon-github"></i>
									</a>
								</li>
								<li>
									<a href="https://www.youtube.com/channel/UC972wwbPrKXW-YlXCPGPbQw" class="tooltip top" title="YouTube">
										<i class="icon-youtube"></i>
									</a>
								</li>
								<li>
									<a href="https://twitter.com/piggahmonster" class="tooltip top" title="Twitter">
										<i class="icon-twitter"></i>
									</a>
								</li>
							<li><a href="../../blog/feeds/all.atom.xml" class="tooltip top" title="RSS"><i class="icon-rss"></i></a></li>
						</ul>
					</div>
			</div>
			<!-- Container / End -->
		</div>
		<!-- Footer Bottom / End -->

	<!-- Javascripts -->
	<script src="../../theme/js/jquery.min.js"></script>
	</body>
</html>